<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹å®«æ ¼åˆ‡å›¾å·¥å…· (å¢å¼ºç‰ˆ)</title>
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #111827;
            --text-sub: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            padding: 20px;
            user-select: none;
        }

        .container { max-width: 900px; margin: 0 auto; }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn:hover { background-color: var(--primary-hover); }
        .btn-outline { background: transparent; border: 1px solid #ccc; color: #333; }
        .btn-outline:hover { border-color: #333; }

        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-area {
            background: var(--card-bg);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        .upload-area:hover { border-color: var(--primary-color); background: #eef2ff; }
        input[type="file"] { display: none; }

        /* ç¼–è¾‘å™¨åŒºåŸŸ */
        #editorSection { display: none; background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); }
        
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            gap: 15px;
        }

        .tool-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .zoom-controls input[type="range"] {
            width: 120px;
            cursor: pointer;
        }

        /* å¢å¼ºå¼€å…³æ ·å¼ */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(20px); }
        .switch-label { font-size: 0.9rem; color: var(--text-main); font-weight: 500; }

        /* è§†å£ä¸å›¾ç‰‡ */
        .editor-viewport {
            position: relative;
            width: 100%;
            height: 500px;
            background-color: #333;
            overflow: hidden;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab; /* æç¤ºå¯ä»¥æ‹–æ‹½ */
        }
        .editor-viewport:active { cursor: grabbing; }

        #sourceImage {
            display: block;
            max-width: 100%;
            max-height: 100%;
            transition: transform 0.1s linear;
            pointer-events: none;
            transform-origin: center center;
        }

        /* å¢å¼ºæ•ˆæœçš„ CSS ç±» (é¢„è§ˆç”¨) */
        .image-enhanced {
            filter: contrast(1.2) saturate(1.2) brightness(1.05);
        }

        /* è£å‰ªæ¡† */
        #cropBox {
            position: absolute;
            top: 50%; left: 50%;
            width: 200px; height: 200px;
            transform: translate(-50%, -50%);
            cursor: move;
            z-index: 10;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            border: 2px solid #fff;
        }
        .grid-line {
            position: absolute; background: rgba(255, 255, 255, 0.5); pointer-events: none;
        }
        .grid-h { width: 100%; height: 1px; top: 33.33%; left: 0; }
        .grid-h2 { width: 100%; height: 1px; top: 66.66%; left: 0; }
        .grid-v { height: 100%; width: 1px; left: 33.33%; top: 0; }
        .grid-v2 { height: 100%; width: 1px; left: 66.66%; top: 0; }

        /* ç»“æœåŒºåŸŸ */
        #resultSection { display: none; margin-top: 20px; background: var(--card-bg); padding: 20px; border-radius: 12px; }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .grid-item {
            position: relative; background: #eee; border-radius: 4px; overflow: hidden;
            aspect-ratio: 1; border: 1px solid #ddd;
        }
        .grid-item img { width: 100%; height: 100%; object-fit: contain; }
        .grid-btn {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.6); color: white; border: none;
            padding: 5px; font-size: 12px; cursor: pointer;
            opacity: 0; transition: opacity 0.2s;
        }
        .grid-item:hover .grid-btn { opacity: 1; }

        /* æç¤ºä¸åŠ è½½ */
        .loader { display: none; margin: 20px auto; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px;
            font-size: 0.9rem; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 999;
        }
    </style>
</head>
<body>

<div class="container">
    <header style="text-align: center; margin-bottom: 20px;">
        <h1>ä¹å®«æ ¼åˆ‡å›¾ (é«˜æ¸…å¢å¼ºç‰ˆ)</h1>
        <p>æ»šè½®ç¼©æ”¾ â€¢ æ‹–åŠ¨é€‰æ¡† â€¢ ä¸€é”®é«˜æ¸…å¢å¼º</p>
    </header>

    <!-- 1. ä¸Šä¼  -->
    <div class="upload-area" id="uploadArea">
        <input type="file" id="fileInput" accept="image/*">
        <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“·</div>
        <div style="font-size: 1.1rem;">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
        <div style="color: #999; font-size: 0.9rem; margin-top: 5px;">æ”¯æŒ JPG, PNG</div>
    </div>

    <!-- 2. ç¼–è¾‘å™¨ -->
    <section id="editorSection">
        <div class="toolbar">
            <div class="tool-group">
                <!-- ç¼©æ”¾æ§åˆ¶ -->
                <div class="zoom-controls">
                    <span style="font-size: 0.9rem; color: #666;">ç¼©æ”¾:</span>
                    <input type="range" id="zoomSlider" min="0.5" max="5.0" step="0.1" value="1">
                    <span id="zoomValue" style="font-size: 0.9rem; width: 45px;">100%</span>
                </div>
                
                <!-- åˆ†éš”çº¿ -->
                <div style="width: 1px; height: 24px; background: #ddd; margin: 0 10px;"></div>

                <!-- é«˜æ¸…å¼€å…³ -->
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label class="switch">
                        <input type="checkbox" id="hdToggle">
                        <span class="slider"></span>
                    </label>
                    <span class="switch-label">å›¾ç‰‡å¢å¼º(å˜æ¸…æ™°)</span>
                </div>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn btn-outline" onclick="resetUpload()">é‡é€‰</button>
                <button class="btn" id="startCutBtn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z"></path></svg>
                    ç¡®è®¤åˆ‡å›¾
                </button>
            </div>
        </div>

        <div class="editor-viewport" id="viewport">
            <img id="sourceImage" src="">
            
            <div id="cropBox">
                <div class="grid-line grid-h"></div>
                <div class="grid-line grid-h2"></div>
                <div class="grid-line grid-v"></div>
                <div class="grid-line grid-v2"></div>
            </div>
        </div>
        <p style="text-align: center; font-size: 0.85rem; color: #999; margin-top: 10px;">æç¤ºï¼šé¼ æ ‡æ»šè½®ç¼©æ”¾å›¾ç‰‡ï¼Œæ‹–åŠ¨ç™½æ¡†è°ƒæ•´ä½ç½®</p>
    </section>

    <!-- 3. ç»“æœ -->
    <section id="resultSection">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>åˆ‡å›¾ç»“æœ</h3>
            <button class="btn" onclick="downloadAll()" style="font-size: 0.9rem;">ä¸‹è½½å…¨éƒ¨</button>
        </div>
        <div class="grid-container" id="gridContainer"></div>
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn btn-outline" onclick="backToEdit()">è¿”å›ä¿®æ”¹</button>
        </div>
    </section>
</div>

<div class="loader" id="loader"></div>
<div class="toast" id="toast">æ¶ˆæ¯æç¤º</div>

<script>
    // === å…¨å±€å˜é‡ ===
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const editorSection = document.getElementById('editorSection');
    const resultSection = document.getElementById('resultSection');
    const viewport = document.getElementById('viewport');
    const sourceImage = document.getElementById('sourceImage');
    const cropBox = document.getElementById('cropBox');
    const zoomSlider = document.getElementById('zoomSlider');
    const zoomValue = document.getElementById('zoomValue');
    const hdToggle = document.getElementById('hdToggle');
    const gridContainer = document.getElementById('gridContainer');
    const loader = document.getElementById('loader');

    let originalImage = null; 
    let generatedImages = []; 
    let currentScale = 1;
    
    // æ‹–æ‹½çŠ¶æ€
    let isDragging = false;
    let dragStart = { x: 0, y: 0 };
    let boxStart = { left: 0, top: 0 };

    // === 1. ä¸Šä¼ å¤„ç† ===
    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.borderColor = 'var(--primary-color)'; });
    uploadArea.addEventListener('dragleave', () => { uploadArea.style.borderColor = ''; });
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '';
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });

    function handleFile(file) {
        if (!file.type.startsWith('image/')) {
            showToast('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶');
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                originalImage = img;
                initEditor();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    // === 2. ç¼–è¾‘å™¨é€»è¾‘ (ç¼©æ”¾ & æ»šè½®) ===
    function initEditor() {
        uploadArea.style.display = 'none';
        resultSection.style.display = 'none';
        editorSection.style.display = 'block';
        gridContainer.innerHTML = '';

        sourceImage.src = originalImage.src;
        
        // é‡ç½®çŠ¶æ€
        zoomSlider.value = 1;
        currentScale = 1;
        zoomValue.textContent = '100%';
        sourceImage.style.transform = `scale(1)`;
        
        // é‡ç½®å¢å¼ºå¼€å…³
        hdToggle.checked = false;
        sourceImage.classList.remove('image-enhanced');

        setTimeout(() => {
            resetCropBox();
            initDragEvents();
        }, 100);
    }

    // æ»šè½®ç¼©æ”¾åŠŸèƒ½
    viewport.addEventListener('wheel', (e) => {
        e.preventDefault(); // é˜»æ­¢é¡µé¢æ»šåŠ¨
        
        // è®¡ç®—ç¼©æ”¾æ–¹å‘
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        let newScale = parseFloat(currentScale) + delta;

        // é™åˆ¶èŒƒå›´
        if (newScale < 0.5) newScale = 0.5;
        if (newScale > 5.0) newScale = 5.0;

        updateScale(newScale);
    }, { passive: false });

    // æ»‘å—ç¼©æ”¾
    zoomSlider.addEventListener('input', (e) => {
        updateScale(parseFloat(e.target.value));
    });

    function updateScale(val) {
        currentScale = val;
        zoomSlider.value = val;
        zoomValue.textContent = Math.round(val * 100) + '%';
        sourceImage.style.transform = `scale(${val})`;
        clampCropBox(); // ç¼©æ”¾åä¿®æ­£è£å‰ªæ¡†ä½ç½®
    }

    // å¢å¼ºå¼€å…³äº‹ä»¶
    hdToggle.addEventListener('change', (e) => {
        if (e.target.checked) {
            sourceImage.classList.add('image-enhanced');
            showToast('å¢å¼ºæ¨¡å¼å·²å¼€å¯');
        } else {
            sourceImage.classList.remove('image-enhanced');
        }
    });

    function resetCropBox() {
        const viewportRect = viewport.getBoundingClientRect();
        const size = Math.min(viewportRect.width, viewportRect.height) * 0.6;
        
        cropBox.style.width = size + 'px';
        cropBox.style.height = size + 'px';
        cropBox.style.left = '50%';
        cropBox.style.top = '50%';
        cropBox.style.transform = 'translate(-50%, -50%)';
        
        requestAnimationFrame(() => {
            const rect = cropBox.getBoundingClientRect();
            const parentRect = viewport.getBoundingClientRect();
            cropBox.style.transform = 'none';
            cropBox.style.left = (rect.left - parentRect.left) + 'px';
            cropBox.style.top = (rect.top - parentRect.top) + 'px';
            clampCropBox();
        });
    }

    // === 3. æ‹–æ‹½é€»è¾‘ ===
    function initDragEvents() {
        const onMouseDown = (e) => {
            isDragging = true;
            dragStart.x = e.clientX;
            dragStart.y = e.clientY;
            boxStart.left = cropBox.offsetLeft;
            boxStart.top = cropBox.offsetTop;
            cropBox.style.cursor = 'grabbing';
            e.preventDefault();
        };

        const onMouseUp = () => {
            isDragging = false;
            cropBox.style.cursor = 'move';
        };

        const onMouseMove = (e) => {
            if (!isDragging) return;
            const dx = e.clientX - dragStart.x;
            const dy = e.clientY - dragStart.y;
            let newLeft = boxStart.left + dx;
            let newTop = boxStart.top + dy;
            cropBox.style.left = newLeft + 'px';
            cropBox.style.top = newTop + 'px';
            clampCropBox();
        };

        cropBox.onmousedown = onMouseDown;
        window.onmousemove = onMouseMove;
        window.onmouseup = onMouseUp;

        // è§¦æ‘¸æ”¯æŒ
        cropBox.ontouchstart = (e) => {
            const touch = e.touches[0];
            onMouseDown({ clientX: touch.clientX, clientY: touch.clientY, preventDefault: () => e.preventDefault() });
        };
        cropBox.ontouchend = onMouseUp;
        window.ontouchmove = (e) => {
            if(isDragging) {
                const touch = e.touches[0];
                onMouseMove({ clientX: touch.clientX, clientY: touch.clientY });
            }
        };
    }

    function clampCropBox() {
        const boxRect = cropBox.getBoundingClientRect();
        const imgRect = sourceImage.getBoundingClientRect();
        const viewportRect = viewport.getBoundingClientRect();

        let curLeft = cropBox.offsetLeft;
        let curTop = cropBox.offsetTop;
        
        const minLeft = imgRect.left - viewportRect.left;
        const maxLeft = minLeft + imgRect.width - boxRect.width;
        const minTop = imgRect.top - viewportRect.top;
        const maxTop = minTop + imgRect.height - boxRect.height;

        if (curLeft < minLeft) curLeft = minLeft;
        if (curLeft > maxLeft) curLeft = maxLeft;
        if (curTop < minTop) curTop = minTop;
        if (curTop > maxTop) curTop = maxTop;

        cropBox.style.left = curLeft + 'px';
        cropBox.style.top = curTop + 'px';
    }

    // === 4. æ ¸å¿ƒåˆ‡å›¾é€»è¾‘ (å«å¢å¼º) ===
    document.getElementById('startCutBtn').addEventListener('click', () => {
        loader.style.display = 'block';

        const boxRect = cropBox.getBoundingClientRect();
        const imgRect = sourceImage.getBoundingClientRect();
        const ratio = originalImage.naturalWidth / imgRect.width;

        const cropX = (boxRect.left - imgRect.left) * ratio;
        const cropY = (boxRect.top - imgRect.top) * ratio;
        const cropSize = boxRect.width * ratio;

        const cropCanvas = document.createElement('canvas');
        cropCanvas.width = cropSize;
        cropCanvas.height = cropSize;
        const ctx = cropCanvas.getContext('2d');

        // å›¾ç‰‡å¢å¼ºå¤„ç†é€»è¾‘
        if (hdToggle.checked) {
            // åº”ç”¨æ»¤é•œï¼šå¢åŠ å¯¹æ¯”åº¦å’Œé¥±å’Œåº¦ä½¿å›¾åƒçœ‹èµ·æ¥æ›´æ¸…æ™°
            ctx.filter = 'contrast(1.2) saturate(1.2) brightness(1.05)';
        }
        
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        
        ctx.drawImage(
            originalImage, 
            cropX, cropY, cropSize, cropSize, 
            0, 0, cropSize, cropSize
        );

        generateNineGrid(cropCanvas);

        loader.style.display = 'none';
        editorSection.style.display = 'none';
        resultSection.style.display = 'block';
        showToast(hdToggle.checked ? 'åˆ‡å›¾å®Œæˆ (å·²å¢å¼º)' : 'åˆ‡å›¾å®Œæˆï¼');
    });

    function generateNineGrid(sourceCanvas) {
        generatedImages = [];
        gridContainer.innerHTML = '';
        
        const size = sourceCanvas.width;
        const pieceSize = size / 3;

        for (let r = 0; r < 3; r++) {
            for (let c = 0; c < 3; c++) {
                const pCanvas = document.createElement('canvas');
                pCanvas.width = pieceSize;
                pCanvas.height = pieceSize;
                const pCtx = pCanvas.getContext('2d');
                
                // ç»˜åˆ¶åˆ‡ç‰‡
                pCtx.drawImage(
                    sourceCanvas,
                    c * pieceSize, r * pieceSize, pieceSize, pieceSize,
                    0, 0, pieceSize, pieceSize
                );

                const dataUrl = pCanvas.toDataURL('image/png');
                const fileName = `grid_${r*3 + c + 1}.png`;
                generatedImages.push({ name: fileName, url: dataUrl });

                const div = document.createElement('div');
                div.className = 'grid-item';
                div.innerHTML = `<img src="${dataUrl}"><button class="grid-btn" onclick="downloadOne('${dataUrl}', '${fileName}')">ä¸‹è½½</button>`;
                gridContainer.appendChild(div);
            }
        }
    }

    // === 5. è¾…åŠ©åŠŸèƒ½ ===
    function resetUpload() {
        fileInput.value = '';
        originalImage = null;
        uploadArea.style.display = 'block';
        editorSection.style.display = 'none';
        resultSection.style.display = 'none';
    }

    function backToEdit() {
        resultSection.style.display = 'none';
        editorSection.style.display = 'block';
    }

    window.downloadOne = function(url, name) {
        const a = document.createElement('a');
        a.href = url;
        a.download = name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    window.downloadAll = function() {
        if(generatedImages.length === 0) return;
        showToast('å¼€å§‹æ‰“åŒ…ä¸‹è½½...');
        generatedImages.forEach((img, i) => {
            setTimeout(() => window.downloadOne(img.url, img.name), i * 200);
        });
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 2500);
    }
</script>

</body>
</html>
